<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طرق الدفع</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- إرجاع لينكات التصميم اللي أنت عملتها -->
    <link href="css/sweetalert.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <!-- خط Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
    </style>
</head>

<body>
    <div class="wrapper">
       <nav id="sidebar">
            <div class="sidebar-header">
                <a class="text-align-center" href="#">
                    <a href="index.html">
                        <img src="img/logo/logo.png" alt="Logo" height="35" />
                    </a>
                </a>
            </div>

            <ul class="list-unstyled components">
                <!-- المبيعات -->
                <li>
                    <a href="#salesSubmenu" data-bs-toggle="collapse">
                        <i class="bi bi-cart"></i> المبيعات
                    </a>
                    <ul class="collapse list-unstyled" id="salesSubmenu">
                        <li>
                            <a href="create-invoice.html"><i class="bi bi-file-text"></i> فاتورة
                                مبيعات</a>
                        </li>
                        <li>
                            <a href="invoices-list.html"><i class="bi bi-gear"></i> إدارة
                                الفواتير</a>
                        </li>
                        <li>
                            <a href="customer-payments.html"><i class="bi bi-cash"></i> مدفوعات
                                العملاء</a>
                        </li>
                    </ul>
                </li>

                <!-- العملاء -->
                <li>
                    <a href="#customersSubmenu" data-bs-toggle="collapse">
                        <i class="bi bi-people"></i> العملاء
                    </a>
                    <ul class="collapse list-unstyled" id="customersSubmenu">
                        <li>
                            <a href="customers.html"><i class="bi bi-person-lines-fill"></i>
                                إدارة العملاء</a>
                        </li>
                        <li>
                            <a href="crm.html"><i class="bi bi-chat-dots"></i> إدارة
                                علاقات العملاء</a>
                        </li>
                        <li>
                            <a href="customer-followup.html"><i class="bi bi-calendar-check"></i> متابعة
                                العملاء</a>
                        </li>
                        <li>
                            <a href="customer-reports.html"><i class="bi bi-bar-chart"></i> تقارير
                                العملاء</a>
                        </li>
                        <li>
                            <a href="customer-notifications.html"><i class="bi bi-bell"></i> إشعارات
                                العملاء</a>
                        </li>
                    </ul>
                </li>

                <!-- المشتريات -->
                <li>
                    <a href="#purchasesSubmenu" data-bs-toggle="collapse">
                        <i class="bi bi-bag"></i> المشتريات
                    </a>
                    <ul class="collapse list-unstyled" id="purchasesSubmenu">
                        <li>
                            <a href="suppliers.html"><i class="bi bi-people"></i> إدارة
                                الموردين</a>
                        </li>
                        <li>
                            <a href="purchase-orders.html"><i class="bi bi-cart-plus"></i> طلبات
                                الشراء</a>
                        </li>
                        <li>
                            <a href="purchase-invoices.html"><i class="bi bi-receipt"></i> فواتير
                                الشراء</a>
                        </li>
                        <li>
                            <a href="supplier-payments.html"><i class="bi bi-cash"></i> مدفوعات
                                الموردين</a>
                        </li>
                        <li>
                            <a href="purchase-reports.html"><i class="bi bi-bar-chart"></i> تقارير
                                المشتريات</a>
                        </li>
                    </ul>
                </li>

                <!-- المخازن -->
                <li>
                    <a href="#inventorySubmenu" data-bs-toggle="collapse">
                        <i class="bi bi-box-seam"></i> المخازن
                    </a>
                    <ul class="collapse list-unstyled" id="inventorySubmenu">
                        <li>
                            <a href="products.html"><i class="bi bi-box"></i> المنتجات</a>
                        </li>
                        <li>
                            <a href="inventory-check.html"><i class="bi bi-list-check"></i> إدارة
                                الجرد</a>
                        </li>
                        <li>
                            <a href="inventory-movement.html"><i class="bi bi-arrow-left-right"></i> حركة
                                المخزون</a>
                        </li>
                        <li>
                            <a href="warehouses.html"><i class="bi bi-house"></i> إدارة
                                المستودعات</a>
                        </li>
                        <li>
                            <a href="track-products.html"><i class="bi bi-search"></i> تتبع
                                المنتجات</a>
                        </li>
                        <li>
                            <a href="inventory-settings.html"><i class="bi bi-gear"></i> إعدادات
                                المخازن</a>
                        </li>
                        <li>
                            <a href="inventory-reports.html"><i class="bi bi-bar-chart"></i> تقارير
                                المخازن</a>
                        </li>
                        <li>
                            <a href="inventory-notifications.html"><i class="bi bi-bell"></i> إشعارات
                                المخزون</a>
                        </li>
                        <li>
                            <a href="transfer-products.html"><i class="bi bi-arrow-left-right"></i> نقل
                                المنتجات</a>
                        </li>
                        <li>
                            <a href="shelves-management.html"><i class="bi bi-boxes"></i> إدارة الأرفف</a>
                        </li>
                        <li>
                            <a href="barcode-management.html"><i class="bi bi-upc-scan"></i> إدارة
                                الباركود</a>
                        </li>
                        <li>
                            <a href="bundled-products.html"><i class="bi bi-boxes"></i> المنتجات
                                المجمعة</a>
                        </li>
                    </ul>
                </li>

                <!-- الخزينة -->
                <li>
                    <a href="#treasurySubmenu" data-bs-toggle="collapse">
                        <i class="bi bi-cash-stack"></i> الخزينة
                    </a>
                    <ul class="collapse list-unstyled" id="treasurySubmenu">
                        <li>
                            <a href="revenues.html"><i class="bi bi-arrow-down"></i>
                                الإيرادات</a>
                        </li>
                        <li>
                            <a href="create-revenue.html"><i class="bi bi-plus"></i> إضافة إيراد</a>
                        </li>
                        <li>
                            <a href="edit-revenue.html"><i class="bi bi-pencil"></i> تعديل إيراد</a>
                        </li>
                        <li>
                            <a href="view-revenue.html"><i class="bi bi-eye"></i> معاينة إيراد</a>
                        </li>
                        <li>
                            <a href="expenses.html"><i class="bi bi-arrow-up"></i> المصروفات</a>
                        </li>
                        <li>
                            <a href="create-expense.html"><i class="bi bi-plus"></i> إضافة مصروف</a>
                        </li>
                        <li>
                            <a href="edit-expense.html"><i class="bi bi-pencil"></i> تعديل مصروف</a>
                        </li>
                        <li>
                            <a href="view-expense.html"><i class="bi bi-eye"></i> معاينة مصروف</a>
                        </li>
                        <li>
                            <a href="current-balance.html"><i class="bi bi-wallet"></i> الرصيد
                                الحالي</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg bg-body-tertiary">
                <div class="container-fluid">
                    <div class="d-flex align-items-center">
                        <button id="sidebarCollapse" class="btn btn-link text-dark d-lg-none me-2">
                            <i class="bi bi-list fs-4"></i>
                        </button>
                    </div>
                    <div class="d-none d-md-block mx-auto">
                        <h4 class="mb-0">طرق الدفع</h4>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-primary" id="savePaymentButton">
                            <i class="bi bi-save"></i> حفظ
                        </button>
                        <a href="create-invoice.html" class="btn btn-secondary">
                            <i class="bi bi-arrow-right"></i> رجوع
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Payment Methods Form -->
            <div class="container-fluid py-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">اختيار طرق الدفع</h5>
                        <!-- ملاحظة للربط مع Django: هنا هتستخدم Django form -->
                        <!-- مثال: <form method="POST"> {% csrf_token %} {{ form.as_p }} </form> -->
                        <form>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="totalAmount" class="form-label">إجمالي الفاتورة</label>
                                    <input type="number" class="form-control" id="totalAmount" name="total_amount" readonly>
                                    <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Invoice -->
                                    <!-- مثال: {{ form.total_amount }} -->
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="cashPayment" class="form-label">نقدي</label>
                                    <input type="number" class="form-control" id="cashPayment" name="cash_payment" placeholder="أدخل المبلغ" oninput="updateRemaining()">
                                    <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Payment -->
                                    <!-- مثال: {{ form.cash_payment }} -->
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="creditPayment" class="form-label">آجل</label>
                                    <input type="number" class="form-control" id="creditPayment" name="credit_payment" placeholder="أدخل المبلغ" oninput="checkCreditPayment()">
                                    <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Payment -->
                                    <!-- مثال: {{ form.credit_payment }} -->
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="bankPayment" class="form-label">بنك</label>
                                    <input type="number" class="form-control" id="bankPayment" name="bank_payment" placeholder="أدخل المبلغ" oninput="updateRemaining()">
                                    <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Payment -->
                                    <!-- مثال: {{ form.bank_payment }} -->
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="vodafoneCashPayment" class="form-label">فودافون كاش</label>
                                    <input type="number" class="form-control" id="vodafoneCashPayment" name="vodafone_cash_payment" placeholder="أدخل المبلغ" oninput="updateRemaining()">
                                    <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Payment -->
                                    <!-- مثال: {{ form.vodafone_cash_payment }} -->
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="remainingAmount" class="form-label">المبلغ المتبقي</label>
                                    <input type="number" class="form-control" id="remainingAmount" name="remaining_amount" readonly>
                                    <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Payment -->
                                    <!-- مثال: {{ form.remaining_amount }} -->
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Customer Registration -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">تسجيل عميل جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <div class="mb-3">
                            <label for="newCustomerName" class="form-label">اسم العميل</label>
                            <input type="text" class="form-control" id="newCustomerName" name="new_customer_name" required>
                            <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Customer -->
                            <!-- مثال: {{ form.new_customer_name }} -->
                        </div>
                        <div class="mb-3">
                            <label for="newCustomerPhone" class="form-label">رقم التليفون</label>
                            <input type="text" class="form-control" id="newCustomerPhone" name="new_customer_phone" required>
                            <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Customer -->
                            <!-- مثال: {{ form.new_customer_phone }} -->
                        </div>
                        <div class="mb-3">
                            <label for="newCustomerGovernorate" class="form-label">المحافظة</label>
                            <select class="form-select" id="newCustomerGovernorate" name="new_customer_governorate" required>
                                <option value="">اختر المحافظة</option>
                                <option value="cairo">القاهرة</option>
                                <option value="giza">الجيزة</option>
                                <option value="alexandria">الإسكندرية</option>
                            </select>
                            <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Customer -->
                            <!-- مثال: {{ form.new_customer_governorate }} -->
                        </div>
                        <div class="mb-3">
                            <label for="newCustomerCenter" class="form-label">المركز</label>
                            <input type="text" class="form-control" id="newCustomerCenter" name="new_customer_center" required>
                            <!-- ملاحظة لـ Django: الحقل ده ممكن يتربط مع موديل Customer -->
                            <!-- مثال: {{ form.new_customer_center }} -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">حفظ العميل</button>
                </div>
            </div>
        </div>
    </div>

    <!-- إرجاع لينكات الـ JS -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/sweetalert.js"></script>
    <script src="js/main.js"></script>
    <script>
        // استرجاع إجمالي الفاتورة من localStorage
        const totalAmount = parseFloat(localStorage.getItem('invoiceTotal')) || 0;
        document.getElementById('totalAmount').value = totalAmount.toFixed(2);
        document.getElementById('remainingAmount').value = totalAmount.toFixed(2);

        // استرجاع نوع العميل
        const customerType = localStorage.getItem('customerType') || 'cash';
        let customerRegistered = customerType === 'credit';

        // التحقق من حقل آجل
        function checkCreditPayment() {
            const creditPayment = parseFloat(document.getElementById('creditPayment').value) || 0;
            if (creditPayment > 0 && !customerRegistered) {
                new bootstrap.Modal(document.getElementById('customerModal')).show();
            }
            updateRemaining();
        }

        // تحديث المبلغ المتبقي
        function updateRemaining() {
            const cash = parseFloat(document.getElementById('cashPayment').value) || 0;
            const credit = parseFloat(document.getElementById('creditPayment').value) || 0;
            const bank = parseFloat(document.getElementById('bankPayment').value) || 0;
            const vodafoneCash = parseFloat(document.getElementById('vodafoneCashPayment').value) || 0;

            const totalPaid = cash + credit + bank + vodafoneCash;
            const remaining = totalAmount - totalPaid;
            document.getElementById('remainingAmount').value = remaining.toFixed(2);

            if (totalPaid > totalAmount) {
                Swal.fire('تحذير', 'المبلغ المدفوع أكبر من إجمالي الفاتورة', 'warning');
            }
        }

        // حفظ بيانات العميل من المودال
        function saveCustomer() {
            const customerName = document.getElementById('newCustomerName').value;
            if (customerName) {
                customerRegistered = true;
                bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
            } else {
                Swal.fire('خطأ', 'يرجى إدخال اسم العميل', 'error');
            }
            // ملاحظة لـ Django: ممكن تعمل API لحفظ بيانات العميل
        }

        // حفظ طرق الدفع
        document.getElementById('savePaymentButton').addEventListener('click', function () {
            const creditPayment = parseFloat(document.getElementById('creditPayment').value) || 0;
            if (creditPayment > 0 && !customerRegistered) {
                Swal.fire('خطأ', 'يرجى تسجيل العميل أولاً', 'error');
                return;
            }

            const remaining = parseFloat(document.getElementById('remainingAmount').value);
            if (remaining > 0) {
                Swal.fire('تحذير', 'يرجى دفع المبلغ المتبقي', 'warning');
            } else {
                Swal.fire({
                    title: 'حفظ الفاتورة',
                    text: 'تم حفظ الفاتورة وطرق الدفع بنجاح!',
                    icon: 'success',
                    confirmButtonText: 'موافق'
                }).then(() => {
                    localStorage.removeItem('invoiceTotal');
                    localStorage.removeItem('customerType');
                    window.location.href = 'invoices-list.html';
                    // ملاحظة لـ Django: ممكن تعمل redirect لصفحة قائمة الفواتير
                    // مثال: window.location.href = "{% url 'invoices_list' %}";
                });
            }
        });
    </script>
</body>

</html>